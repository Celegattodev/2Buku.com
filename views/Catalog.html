<!DOCTYPE html>
<html lang="pt-br">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Catálogo</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"
    integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous" />
  <link rel="stylesheet" href="/css/global.css" />
  <link rel="stylesheet" href="/css/styles.css" />
  <link rel="stylesheet" href="/css/styles.css.map" />
  <link rel="stylesheet" href="/css/catalogo/Catalog.css" />
  <link rel="stylesheet" href="/css/navbar.css">
</head>

<body>
  <!-- VLIBRAS -->
  <div vw class="enabled">
    <div vw-access-button class="active"></div>
    <div vw-plugin-wrapper>
      <div class="vw-plugin-top-wrapper"></div>
    </div>
  </div>
  <script src="https://vlibras.gov.br/app/vlibras-plugin.js"></script>
  <script>
    new window.VLibras.Widget('https://vlibras.gov.br/app');
  </script>

  <!-- NAVBAR -->
  <header>
    <nav id="navbar">
      <img id="navbar_logo" src="/img/Logo-Buku-branco.png" alt="Logo" />
      <ul id="nav_list">
        <li class="nav-item active"><a href="#">Sobre Nós</a></li>
        <li class="nav-item"><a href="#">Funcionamento</a></li>
        <li class="nav-item"><a href="#">Perguntas Frequentes</a></li>
      </ul>
      <button class="btn-default" id="register-btn">Cadastrar/Entrar</button>
      <button id="mobile_btn">
        <i class="fa-solid fa-bars"></i>
      </button>
    </nav>
    <div id="mobile_menu">
      <ul id="mobile_nav_list">
        <li class="nav-item"><a href="#">Sobre Nós</a></li>
        <li class="nav-item"><a href="#">Funcionamento</a></li>
        <li class="nav-item"><a href="#">Perguntas Frequentes</a></li>
      </ul>
      <button class="btn-default" id="mobile-register-btn">Cadastrar/Entrar</button>
    </div>
  </header>

  <!-- PRODUCT SLIDER 1 -->
  <section class="product">
    <h2 class="product-category">• Mais Populares</h2>
    <button class="pre-btn">
      <img src="/img/arrow-icon.png" alt="" />
    </button>
    <button class="nxt-btn">
      <img src="/img/arrow-icon.png" alt="" />
    </button>
    <div class="product-container" id="popular-books-container">
      <!-- Os livros mais populares serão carregados aqui pelo JavaScript -->
    </div>
  </section>

  <!-- PRODUCT SLIDER 2 -->
  <section class="product">
    <h2 class="product-category">• Novidades</h2>
    <button class="pre-btn">
      <img src="/img/arrow-icon.png" alt="" />
    </button>
    <button class="nxt-btn">
      <img src="/img/arrow-icon.png" alt="" />
    </button>
    <div class="product-container" id="latest-books-container">
      <!-- Os últimos livros adicionados serão carregados aqui pelo JavaScript -->
    </div>
  </section>

  <!-- Modal Container -->
  <div id="modalContainer"></div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"
    integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz"
    crossorigin="anonymous"></script>
  <script src="/js/catalogo/Catalog.js"></script>
  <script src="/js/navbar.js"></script>
  <script>
    document.addEventListener('DOMContentLoaded', function () {
      fetch('/catalog-data')
        .then(response => response.json())
        .then(data => {
          const popularBooksContainer = document.getElementById('popular-books-container');
          const latestBooksContainer = document.getElementById('latest-books-container');

          data.popularBooks.forEach(book => {
            const bookCard = createBookCard(book);
            popularBooksContainer.appendChild(bookCard);
          });

          data.latestBooks.forEach(book => {
            const bookCard = createBookCard(book);
            latestBooksContainer.appendChild(bookCard);
          });
        })
        .catch(error => console.error('Erro ao carregar os livros:', error));
    });

    function createBookCard(book) {
      const bookCard = document.createElement('div');
      bookCard.classList.add('product-card');

      const bookImage = document.createElement('div');
      bookImage.classList.add('product-image');
      const img = document.createElement('img');
      img.src = book.imageUrl || '/img/default-book-image.jpg';
      img.classList.add('product-thumb');
      bookImage.appendChild(img);

      const addButton = document.createElement('button');
      addButton.classList.add('card-btn');
      addButton.textContent = 'Adicionar aos Favoritos ♥';
      addButton.addEventListener('click', () => addToFavorites(book));
      bookImage.appendChild(addButton);

      bookCard.appendChild(bookImage);

      const bookInfo = document.createElement('div');
      bookInfo.classList.add('product-info');
      const title = document.createElement('h4');
      title.classList.add('product-title');
      title.textContent = book.title;
      bookInfo.appendChild(title);

      const author = document.createElement('p');
      author.classList.add('product-author');
      author.innerHTML = `por <strong>${book.author}</strong>`;
      bookInfo.appendChild(author);

      if (book.genres) {
        book.genres.forEach(genre => {
          const badge = document.createElement('span');
          badge.classList.add('badge', 'rounded-pill', 'text-bg-primary');
          badge.textContent = genre;
          bookInfo.appendChild(badge);
        });
      }

      bookCard.addEventListener('click', () => showBookDetails(book));

      bookCard.appendChild(bookInfo);

      return bookCard;
    }

    function showBookDetails(book) {
      fetch(`https://www.googleapis.com/books/v1/volumes/${book.googleBooksId}`)
        .then(response => response.json())
        .then(bookDetails => {
          const bookInfo = bookDetails.volumeInfo;
          Promise.all([
            translateGenres(bookInfo.categories),
            translateText(bookInfo.description)
          ])
            .then(([translatedGenres, translatedDescription]) => {
              bookInfo.categories = translatedGenres;
              bookInfo.description = translatedDescription;
              displayBookDetails(bookInfo);
            })
            .catch(error => {
              console.error('Erro ao traduzir gêneros ou sinopse:', error);
              displayBookDetails(bookInfo);
            });
        })
        .catch(error => console.error('Erro ao buscar detalhes do livro:', error));
    }

    function displayBookDetails(bookInfo) {
      const modalContent = `
        <div class="modal fade" id="bookDetailsModal" tabindex="-1" aria-labelledby="bookDetailsModalLabel" aria-hidden="true">
          <div class="modal-dialog modal-lg">
            <div class="modal-content">
              <div class="modal-header">
                <h5 class="modal-title" id="bookDetailsModalLabel">${bookInfo.title}</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
              </div>
              <div class="modal-body">
                <div class="row">
                  <div class="col-md-4">
                    <img src="${bookInfo.imageLinks?.thumbnail.replace('http://', 'https://') || 'https://via.placeholder.com/128x192.png?text=No+Cover'}" class="img-fluid mb-3" alt="${bookInfo.title}">
                  </div>
                  <div class="col-md-8">
                    <p><strong>Autor:</strong> ${bookInfo.authors?.join(', ') || 'Desconhecido'}</p>
                    <p><strong>Gênero:</strong> ${bookInfo.categories?.join(', ') || 'Desconhecido'}</p>
                    <p><strong>Editora:</strong> ${bookInfo.publisher || 'Desconhecido'}</p>
                    <p><strong>Ano de Publicação:</strong> ${formatDate(bookInfo.publishedDate) || 'Desconhecido'}</p>
                    <p><strong>Sinopse:</strong> ${bookInfo.description || 'Não disponível'}</p>
                  </div>
                </div>
              </div>
              <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fechar</button>
              </div>
            </div>
          </div>
        </div>
      `;
      document.getElementById('modalContainer').innerHTML = modalContent;
      const modal = new bootstrap.Modal(document.getElementById('bookDetailsModal'));
      modal.show();
    }

    async function translateGenres(genres) {
      if (!genres || genres.length === 0) return ['Desconhecido'];
      const apiKey = 'AIzaSyCvKVY6ptNvOngJl4KgOSIEQPrTXafOQ_k'; // Substitua pela sua chave de API do Google Translate
      const url = `https://translation.googleapis.com/language/translate/v2?key=${apiKey}`;

      const translatedGenres = await Promise.all(genres.map(async (genre) => {
        try {
          const response = await fetch(url, {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json'
            },
            body: JSON.stringify({
              q: genre,
              source: 'en',
              target: 'pt'
            })
          });
          const data = await response.json();
          return data.data.translations[0].translatedText;
        } catch (error) {
          console.error('Erro ao traduzir gênero:', error);
          return genre; // Retorna o gênero original em caso de erro
        }
      }));

      return translatedGenres;
    }

    async function translateText(text) {
      if (!text) return 'Não disponível';
      const apiKey = 'AIzaSyCvKVY6ptNvOngJl4KgOSIEQPrTXafOQ_k'; // Substitua pela sua chave de API do Google Translate
      const url = `https://translation.googleapis.com/language/translate/v2?key=${apiKey}`;
      try {
        const response = await fetch(url, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            q: text,
            source: 'en',
            target: 'pt'
          })
        });
        const data = await response.json();
        return data.data.translations[0].translatedText;
      } catch (error) {
        console.error('Erro ao traduzir texto:', error);
        return text; // Retorna o texto original em caso de erro
      }
    }

    function formatDate(date) {
      if (!date) return 'Desconhecido';
      const [year, month, day] = date.split('-');
      return `${day || '01'}/${month || '01'}/${year}`;
    }

    function addToFavorites(book) {
      fetch('/add-favorite', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify(book)
      })
        .then(response => response.json())
        .then(data => {
          if (data.success) {
            alert('Livro adicionado aos favoritos com sucesso!');
          } else {
            alert('Erro ao adicionar o livro aos favoritos.');
          }
        })
        .catch(error => console.error('Erro ao adicionar o livro aos favoritos:', error));
    }
  </script>
</body>

</html>